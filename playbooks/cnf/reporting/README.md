# Ansible Playbook `test_report_send.yml`: Submit JUnit Report to Collector

## Overview

This folder contains the playbook and its requirements to send data to a reporting system
[test_report_send.yml](playbooks/cnf/reporting/test_report_send.yml`) and also development process supporting data and automation.

To learn more about the roles the playbook uses, refer to Ansible Collection [redhatci.ocp](https://github.com/redhatci/ansible-collection-redhatci-ocp.git)
Specifically the roles:

- [redhatci.ocp.junit2json](https://github.com/redhatci/ansible-collection-redhatci-ocp/tree/main/roles/junit2json)
- [redhatci.ocp.test_report_send](https://github.com/redhatci/ansible-collection-redhatci-ocp/tree/main/roles/test_report_send)
designed to process JUnit XML test reports, convert them to a JSON format,
and then push this data to a data collector (e.g., Splunk via its HTTP Event Collector).

Besides, it provides a way to verify existing code by generating event expected to go to reporting system and compare
it with existing.

The process is managed by a `Makefile` and involves:

1. Setting up a Python virtual environment.
2. A Python script (`tools/gen_playbook_data.py`) that interactively gathers necessary parameters
   and generates an intermediate data file (`output/data.yml`).
3. A Jinja2 template (`templates/test_report_send.yml.j2`) that uses the data from `output/data.yml` to render
   the final Ansible extra variables file (`vars/test_report_send.yml`).
4. Running the Ansible playbook with these generated extra variables.

## Prerequisites

Before you begin, ensure you have the following installed on your system:

| #  | Tool                                             | Run       | Min. Version | Description                            |
| -- | ------------------------------------------------ | --------- | ------------ | -------------------------------------- |
| 1. | [GNU Make](https://www.gnu.org/software/make/)   | `make`    | `4.0.0`      | Needed to run `Makefile` & `*.mk`      |
| 2. | [Python 3](https://docs.python.org/3/)           | `python3` | `3.10.0`     | `tools/*.py` and ansible/etc. need it  |
| 3. | [Git](https://git-scm.com/doc)                   | `git`     | `2.10.0`     | for source code management             |
| 4. | [diff](https://www.gnu.org/software/diffutils/)  | `diff`    | `3.12`       | shows diff where applicable            |

The Python dependencies required by the scripts and Ansible will be installed into a virtual environment by
the `make bootstrap` command. These typically described by:

- `requirements.txt`
- for each collection under `meta` in either `requirements.txt` or `ee-requirements.txt`

## Folder Structure

This all is happening under `playbooks/cnf/reporting`
The key files and directories involved are:

- `test_report_send.yml`: The Ansible playbook to send test reports
- `Makefile`: Orchestrates the setup, data generation, rendering, and playbook execution.
- `vars.mk`: configures the `Makefile` defaults
- `vars.local.mk`: specific configurations for roles/playbooks development
- `requirements.txt`: Python dependencies for the virtual environment.
- `tools/*.py`: Python scripts (and tests `tools/test_*.py`)
- `tools/make_wrapper.sh`: temp wrapper for `make` targets
- `templates/test_report_send.yml.j2`: Jinja template for the Ansible extra variables file.
  (This should be created based on the variables expected by the playbook and roles).
- `templates/vars.local.mk.j2`: Jinja template for `vars.local.mk` when applicable
- `output/data.yml`: Intermediate data file generated by the Python script. (Gitignored)
- `vars/test_report_send.yml`: Final extra variables file for Ansible, generated by rendering the Jinja2 template.
  (Gitignored)
- `.venv/`: Default directory for the Python virtual environment. (Gitignored, only exists after `bootstrap` task completed)

## Setup Instructions

1. **Clone the Repository** (if you haven't already).
2. **Bootstrap the Environment:**
    This command creates a Python virtual environment (default: `./.venv`) and installs all necessary dependencies
    - Python content from `requirements.txt`.
    - Ansible content (Collections/Plugins/Modules) from `requirements*.yml`
    - Python content for each collection in `collections/ansible_collections/${namespace}/${role}/meta/requirements.txt`
    - Run: `make bootstrap`
      - If you want to force recreation of an existing virtual environment, use: `make bootstrap RECREATE=1`
      - To use a specific Python interpreter (e.g., python3.9): `make bootstrap PY=python3.9`

## Workflow & Usage

There are 2 main workflows:

1. existing code/CI system update and validation
2. new CI system

A typical workflow involves generating data, rendering variables, and then running the playbook/tests

### Workflows

If you only want to verify existing tests after modifications to either the roles or the playbooks,
you can safely skip Step 2

## Initial setup (done once)

Everything below should run inside `playbooks/cnf/reporting`.

### Step 1: One time setup

This step creates and activate run python virtual env (using `venv`)

```bash

VE_NAME=personal-venv
mkdir -p "${HOME}/.venvs"
python3 -m venv "${HOME}/.venvs/${VE_NAME}"
source "${HOME}/.venvs/${VE_NAME}/bin/activate"
python3 -m pip install --upgrade pip
python3 -m pip install -r ./requirements.txt
```

### Step 2: Setup variables for tests

For new CI system you need to create all relevant variables, incl what is present in the template [test_report_send.yml.j2](playbooks/cnf/reporting/templates/test_report_send.yml.j2)

NOTE: You can run the following process iteratively, but it makes a better sense to go over the template and prepare all
      the files and paths and details ahead.

#### Step 2.1: Generates the template context by default  `data.yml` template

Assuming you have all the data ready to be copy-pasted:

```shell

make gendata
```

##### Interactive Prompts Info

The script will ask for details such as (refer to the script for the exact list and behavior)

| Prompt         | Oblig.  | Parameter                   | Validation        | Description |
| -------------- | ------- | --------------------------- | ----------------- | ----------- |
| Splunk URL     | `True`  | `splunk_url`                | through http HEAD | |
| Splunk Token   | `True`  | `splunk_token`              | UUID format       | |
| Splunk Channel | `True`  | `splunk_channel`            | UUID format       | |
| Splunk Index   | `False` | `splunk_index`              | non-empty str     | |
| Splunk Source  | `False` | `splunk_source`             | non-empty str     | auto-detected by the `test_report_send` role, can be overridden |
| CI System      | `False` | `trs_ci_system`             | value in list     | CI system keyword, refer to role `redhatci.ocp.test_report_send` defaults |
| JUnit files    | `True`  | `junit2_input_reports_list` | valid xml format  | comma-separated list, if prompted |
| metadata file  | `False` | `trs_metadata_path`         | valid json format | |
| Output dir     | `False` | `junit2_output_dir`         | existing dir      | defaults exist in the junit2json role |

#### Step 2.2: Render the template to extranl vars file

After a short list of variable inquiries will Generate template context in a file (default: `output/data.yml`) and prints out 2 next commands: direct jinja invokation or make

```bash
make render
```

The above will generate by default a file `vars/test_report_send.yml` by default.
You can override it by passing `EXTRA_VARS` variable:

```bash
make render EXTRA_VARS=path/to/mylocation.yml
```

#### Step 2.3: Generate venv and setup collections and their dependencies

During the make runs not current, tests only, clean `venv` is used.

Run(*):

```bash
make bootstrap
```

##### Note #1

To recrete everything and re-install `venv` and collections, append `RECREATE=1` to the above `make` command, like so:

```bash
make bootstrap RECREATE=1
```

##### Note #2

To override default collections used (or add new ones) by editing `$(git rev-parse --show-toplevel)/requirements.yml`,
you may with to modify your collections or add others, or even use one from a branch in a fork, like so:

```yaml
---
collections:
 ...
 - name: redhatci.ocp
   source: https://github.com/someuser/ansible-collection-redhatci-ocp.git
   type: git
   version: some-reference-dev-branch-or-tag
 ...

```

**Important:** `version` reference cannot be arbitrary due to not well documented `ansible-galaxy` limitation.

Review the Table:

| Reference Type | Example            | `ansible-galaxy install` | `ansible-lint` (with `--pre`) | Recommendation |
| -------------- | ------------------ | ------------------------ | ----------------------------- | -------------- |
| Commit Hash    | `a1b2c3d4e5f6`     | ✅ Works                 | ✅ Works                      | Best           |
| SemVer Tag     | `v1.2.3`           | ✅ Works                 | ✅ Works                      | Excellent      |
| Simple Branch  | `feature-new-role` | ✅ Works                 | ✅ Works                      | Safe           |
| Special Branch | `feature/new-role` | ✅ Works (usually)       | ❌ FAILS                      | Avoid          |

##### Note #3

**Good news**: after the collections have been installed from `requirements.yml` file, no need to
           manually install python requirements from the collections, it is done automatically.

### Step 2: run tests

Several testing commands:

```shell

.../cnf/reporting $ # run lint over the playbook and the code in `tools/`
.../cnf/reporting $ make lint 
.../cnf/reporting $ # run pytess over tools/test_*.py files
.../cnf/reporting $ make pytest
.../cnf/reporting $ # run dry functests of the reporting playbook+roles using fixtures without sending data to real reporting
.../cnf/reporting $ # a real HEAD request is made to validate the url (you can use mock https services)
.../cnf/reporting $ make test CI_TYPE=dci
.../cnf/reporting $ make test CI_TYPE=jenkins

```

## Development

During the development you need a test harness and repeatable process to follow after code change.

### Several development use cases

#### I. Add/Update template

The main template for creating extra variables is `template/test_report_send.yml.j2`
if you need to add more lines to it, follow the same ideas.
By default, Jinja2 template takes the flat key-value data from `${PWD}/output/data.yml`.
Usually it is generated by running: `make gendata && make render`

The structure of the output of this template (which will be `vars/test_report_send.yml`) should match the example
variables file you intend to use with your playbook.

If you properly update

1. the template file with new variables
2. the script `tools/gen_playbook_extra_vars.py` to create these new variables in `data.yml`

It is relatively easy to test it by comparing expected resulting file vs actual one.

#### II. Troubleshooting/Debugging

The following actions allow customization of the runs:

| Change type     | Item change     | Effect                            |
| --------------- | --------------- | --------------------------------- |
| create file     | `vars.local.mk` | override data in `vars.mk`        |
| `make` variable | `DEV_MODE=1`    | increase verbosity of all scripts |

To generate data for testing without actual CI detection or to simulate skipping the send step.
It passes these options and they transform into the following variables in template context:

| Flag | Context variable | Comment |
| ---- | ---------------- | ------- |
| `--skip-send` | `trs_do_send: false` | this can be set by default via `fixtures/${ci_type}/${playbook}` extra variables file |

Since render depends on `gendata`, `output/data.yml` will be created/updated if necessary before rendering.

### Step 4: Run the Ansible Playbook (make run)

This target activates the virtual environment and executes the Ansible playbook, passing the generated
`vars/test_report_send.yml` as extra variables.

```bash
make run
```
