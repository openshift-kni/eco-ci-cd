# Ansible Playbook `test_report_send.yml`: Submit JUnit Report to Collector

## Overview

This setup provides an Ansible playbook [test_report_send.yml](playbooks/cnf/reporting/test_report_send.yml`)
designed to process JUnit XML test reports, convert them to a JSON format,
and then push this data to a data collector (e.g., Splunk via its HTTP Event Collector).

The process is managed by a `Makefile` and involves:

1. Setting up a Python virtual environment.
2. A Python script (`tools/gen_playbook_data.py`) that interactively gathers necessary parameters
   and generates an intermediate data file (`output/data.yml`).
3. A Jinja2 template (`templates/test_report_send.yml.j2`) that uses the data from `output/data.yml` to render
   the final Ansible extra variables file (`vars/test_report_send.yml`).
4. Running the Ansible playbook with these generated extra variables.

## Prerequisites

Before you begin, ensure you have the following installed on your system:

| #  | Tool | Executable | Minimal Version | Description |
| -- | ---- | ---- | ---- | ---- |
| 1. | [GNU Make](https://www.gnu.org/software/make/) | `make` | `4.0.0` | Needed to run `Makefile` & `*.mk` |
| 2. | [Python 3](https://docs.python.org/3/) | `python3` | `3.10.0` | `tools/*.py` and ansible/etc. need it |
| 3. | [Git](https://git-scm.com/doc) | `git` | `2.10.0` | for source code management |
| 4. | [yq](https://mikefarah.gitbook.io/yq) | `yq` | `4.0.10` |  needed during `bootstrap` target |
| 5. | [diff](https://www.gnu.org/software/diffutils/) | `diff` | `3.12` | shows diff where applicable |

The Python dependencies required by the scripts and Ansible will be installed into a virtual environment by
the `make bootstrap` command. These typically include:

* `ansible`
* `ansible-lint` (good practice)
* `jinja2-cli` (for the `make render` step)
* `ruamel.yaml` (for the Python data generator script)

## Project Structure

This all is happening under `playbooks/cnf/reporting`
The key files and directories involved are:

* `test_report_send.yml`: The main Ansible playbook.
* `Makefile`: Orchestrates the setup, data generation, rendering, and playbook execution.
* `vars.mk`: configures the `Makefile` defaults
* `vars.local.mk`: specific configurations for roles/playbooks development
* `requirements.txt`: Python dependencies for the virtual environment.
* `tools/*.py`: Python scripts (and tests `tools/test_*.py`)
* `tools/make_wrapper.sh`: temp wrapper for `make` targets
* `templates/test_report_send.yml.j2`: Jinja template for the Ansible extra variables file.
  (This should be created based on the variables expected by the playbook and roles).
* `templates/vars.local.mk.j2`: Jinja template for `vars.local.mk` when applicable
* `output/data.yml`: Intermediate data file generated by the Python script. (Gitignored)
* `vars/test_report_send.yml`: Final extra variables file for Ansible, generated by rendering the Jinja2 template.
  (Gitignored)
* `.venv/`: Default directory for the Python virtual environment. (Gitignored, only exists after `bootstrap` task completed)

## Setup Instructions

1. **Clone the Repository** (if you haven't already).
2. **Bootstrap the Environment:**
    This command creates a Python virtual environment (default: `./.venv`) and installs all necessary dependencies
    * Python content from `requirements.txt`.
    * Ansible content (Collections/Plugins/Modules) from `requirements*.yml`
    * Python content for each collection in `collections/ansible_collections/${namespace}/${role}/meta/requirements.txt`
    * Run: `make bootstrap`
      * If you want to force recreation of an existing virtual environment, use: `make bootstrap RECREATE=1`
      * To use a specific Python interpreter (e.g., python3.9): `make bootstrap PY=python3.9`

## Workflow & Usage

The typical workflow involves generating data, rendering variables, and then running the playbook.

### Initial setup (done once)

#### Quick Start

```bash

mkdir -p ~/.venvs
python3 -m venv ~/.venvs/personal-venv
source ~/.venvs/venv-venv/bin/activate
python3 -m pip install --upgrade pip
python3 -m pip install -r ./requireents.txt

make gendata
make render

make bootstap

make lint
make pytest
make test TEST=dci
make test TEST=jenkins

```

#### **Step 1: Generate Data (`make gendata`)**

This target runs the Python script (`tools/gen_playbook_data.py`) which will prompt you for various inputs required
by the playbook and its roles. This information is used to create an intermediate data file (`output/data.yml`).

```bash
make gendata
```

#### Interactive Prompts: The script will ask for details such as (refer to the script for the exact list and behavior)

| Prompt              | Mandate   | Parameter                   | Description |
| ------------------- | --------- | --------------------------- | ----------- |
| Splunk URL          | mandatory |`splunk_url`                 | |
| Splunk Token        | mandatory |`splunk_token`               | |
| Splunk Channel      | mandatory |`splunk_channel`             | |
| Splunk Index        | optional  | `splunk_index`              | |
| Splunk Source       | optional  | `splunk_source`             | auto-detected by the test_report_send role, in development can be overridden here |
| CI System           | optional  | `trs_ci_system`             | CI system keyword |
| XML reports List    | mandatory | `junit2_input_reports_list` | comma-separated list, if prompted |
| metadata file path  | optional  | `trs_metadata_path`         | |
| Output directory    | optional  | `junit2_output_dir`         | defaults exist in the junit2json role |

#### Developer Mode (DEV_MODE)

To generate data for testing without actual CI detection or to simulate skipping the send step.
It passes these options and they transform into the following variables in template context:

| Flag | Context variable | Comment |
| ---- | ---------------- | ------- |
| `--skip-send` | `trs_do_send: false` | this can be set via `fixtures/${test_type}/${playbook}` extra variables file |

### Step 2: (optionally) update the Jinja2 Template (templates/test_report_send.yml.j2) with new variables

This step is crucial and requires you to create the template file.
This Jinja2 template takes the flat key-value data from `${PWD}/output/data.yml` (generated by the Python script) and
structures it into the YAML format that your Ansible playbook (`playbooks/infra/reporting/test_report_send.yml`)
expects as extra variables.

The structure of the output of this template (which will be `vars/test_report_send.yml`) should match the example
variables file you intend to use with your playbook.

### Step 3: Render Ansible Extra Variables

This target uses jinja2-cli to process your `templates/test_report_send.yml.j2` with data from `output/data.yml`.
The result is the final Ansible extra variables file, `vars/test_report_send.yml`.

```bash
make render
```

Since render depends on `gendata`, `output/data.yml` will be created/updated if necessary before rendering.

### Step 4: Run the Ansible Playbook (make run)

This target activates the virtual environment and executes the Ansible playbook, passing the generated
`vars/test_report_send.yml` as extra variables.

```bash
make run
```
