---
# This playbook configures Advanced Cluster Management (ACM) MultiClusterHub and
# Assisted Service on OpenShift clusters.
#
# Prerequisites:
#   - Valid kubeconfig for cluster authentication
#   - ACM operator must be installed
#   - Multicluster Engine operator must be installed
#   - Storage class available for persistent volumes
#
# Usage:
#   ansible-playbook -i inventories/ocp-deployment/build-inventory.py \
#     playbooks/ran/hub-sno-configure-acm.yml \
#     --extra-vars "kubeconfig=/path/to/kubeconfig ocp_version=4.19"
#
# Required variables:
#   kubeconfig: Path to kubeconfig file for cluster authentication
#   ocp_version: OpenShift version for spoke clusters (e.g., "4.19", "4.18", "4.17")
#   share_http_iso_port: Port number for HTTP server hosting ISO files (e.g., 8888)
#   ansible_host: IP address or hostname of the bastion host for HTTP server access
#   disconnected_registry_url: URL of the disconnected container registry
#   disconnected_registry_port: Port number for the disconnected registry
#
# RHCOS ISO Requirements:
#   - RHCOS ISO file must be pre-downloaded and placed in the cache directory
#   - Default cache directory: /opt/cache (configurable via rhcos_cache_dir)
#   - ISO file naming pattern: rhcos-*.iso (e.g., rhcos-4.19.0-x86_64-live.iso)
#   - Only one RHCOS ISO file should be present in the cache directory
#   - The playbook extracts the RHCOS version from the ISO filename
#   - The ISO is copied to the HTTP store data directory for serving to spoke clusters
#
# What it does:
#   1. Configures cluster network settings (routingViaHost and ipForwarding)
#   2. Validates ACM operator is installed (checks for MultiClusterHub CRD)
#   3. Creates MultiClusterHub resource if it doesn't exist
#   4. Waits for MultiClusterHub to reach Running status
#   5. Creates mirror registry ConfigMap for disconnected environments
#   6. Finds RHCOS ISO file in cache directory and extracts version from filename
#   7. Copies RHCOS ISO to HTTP store data directory for serving
#   8. Creates AgentServiceConfig for Assisted Installer with RHCOS ISO URL
#   9. Waits for assisted-service pods to be ready
#   10. Applies Provisioning resource for Metal3
#   11. Waits for metal3 pods to be running
#   12. Enables siteconfig component in MultiClusterHub
#   13. Waits for siteconfig-controller-manager deployment to be available
#
# Important Notes:
#   - MultiClusterHub will be created if it doesn't exist (in multicluster-engine namespace)
#   - RHCOS ISO must be pre-downloaded to the cache directory before running this playbook
#   - HTTP store must be configured and running on the bastion host

- name: Pre-flight validation
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Validate required variables are defined
      ansible.builtin.assert:
        that:
          - kubeconfig is defined
          - kubeconfig | length > 0
          - ocp_version is defined
          - ocp_version | length > 0
        fail_msg: |
          Required variables must be defined:
            - kubeconfig: Path to kubeconfig file
            - ocp_version: OpenShift version (e.g., "4.19", "4.18")

          Usage:
            ansible-playbook playbooks/ran/hub-sno-configure-acm.yml \
              --extra-vars "kubeconfig=/path/to/kubeconfig ocp_version=4.19"

- name: OpenShift MultiClusterHub and Assisted Service Configuration
  hosts: bastion
  gather_facts: false
  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig }}"
  vars:
    mch_namespace: open-cluster-management
    mce_namespace: multicluster-engine
    mch_cr_name: multiclusterhub
    timeout_mch: 600
    timeout_assisted_service: 300
    timeout_metal3: 300
    http_store_data_dir: /opt/http_store/data
    # RHCOS OS Image configuration for spoke cluster deployments
    # ocp_version: REQUIRED - Set via --extra-vars "ocp_version=4.19"
    # rhcos_version: Auto-extracted from ISO filename in cache directory
    # rhcos_iso_url: Auto-generated URL pointing to local bastion HTTP server
    rhcos_version: ""  # Auto-populated from ISO filename
    rhcos_cache_dir: /opt/cache  # Directory containing pre-downloaded RHCOS ISO file
  tasks:

    - name: Validate required variables for HTTP store
      ansible.builtin.assert:
        that:
          - share_http_iso_port is defined
          - ansible_host is defined or inventory_hostname is defined
        fail_msg: "share_http_iso_port and ansible_host must be defined"

    - name: Define cluster network configuration
      ansible.builtin.set_fact:
        cluster_network_patch:
          - op: add
            path: /spec/defaultNetwork/ovnKubernetesConfig/gatewayConfig/routingViaHost
            value: true
          - op: add
            path: /spec/defaultNetwork/ovnKubernetesConfig/gatewayConfig/ipForwarding
            value: Global

    - name: Apply network configuration changes
      register: network_update_status
      kubernetes.core.k8s_json_patch:
        api: operator.openshift.io/v1
        kind: Network
        name: cluster
        patch: "{{ cluster_network_patch }}"

    - name: Wait for network operator update to begin
      kubernetes.core.k8s_info:
        api: operator.openshift.io/v1
        kind: Network
        name: cluster
      register: update_progress
      until: >
        (update_progress.resources | length > 0) and
        (
          (update_progress.resources[0].status.conditions | default([]))
          | selectattr('type', 'equalto', 'Progressing')
          | selectattr('status', 'equalto', 'True')
          | list
          | length
        ) > 0
      retries: 30
      delay: 10
      ignore_errors: true
      when: network_update_status.changed is true
      tags:
        - skip_ansible_lint

    - name: Wait for network operator update to complete
      kubernetes.core.k8s_info:
        api: operator.openshift.io/v1
        kind: Network
        name: cluster
      register: update_complete
      until: >
        (update_complete.resources | length > 0) and
        (
          (update_complete.resources[0].status.conditions | default([]))
          | selectattr('type', 'equalto', 'Progressing')
          | selectattr('status', 'equalto', 'False')
          | list
          | length
        ) > 0
      retries: 60
      delay: 20
      ignore_errors: true

    - name: Fail if network operator did not start updating
      ansible.builtin.fail:
        msg: "Cluster network operator failed to enter updating state."
      when:
        - update_progress is defined
        - update_progress.failed is true

    - name: Fail if network operator update is stuck
      ansible.builtin.fail:
        msg: "Cluster network operator update did not complete successfully."
      when: update_complete.failed is true

    - name: Check if MultiClusterHub CRD exists
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: multiclusterhubs.operator.open-cluster-management.io
      register: mch_crd_check

    - name: Validate ACM operator is installed
      ansible.builtin.assert:
        that:
          - mch_crd_check.resources | length > 0
        fail_msg: |
          ERROR: ACM operator is not installed!
          The MultiClusterHub CRD was not found in the cluster.

    - name: Check if MultiClusterHub exists (cluster-scoped no namespace)
      kubernetes.core.k8s_info:
        api_version: operator.open-cluster-management.io/v1
        kind: MultiClusterHub
        name: "{{ mch_cr_name }}"
        namespace: "{{ mce_namespace }}"
      register: mch_info

    - name: Create MultiClusterHub Resource
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'templates/multiClusterHub.j2') }}"
      when: mch_info.resources | length == 0

    - name: Wait for MultiClusterHub to reach Running status
      kubernetes.core.k8s_info:
        api_version: operator.open-cluster-management.io/v1
        kind: MultiClusterHub
        name: "{{ mch_cr_name }}"
        namespace: "{{ mce_namespace }}"
      register: mch_info
      until:
        - mch_info.resources | length > 0
        - mch_info.resources[0].status.phase is defined
        - mch_info.resources[0].status.phase == "Running"
      retries: "{{ (timeout_mch | int / 10) | int }}"
      delay: 10

    - name: Report MultiClusterHub status
      ansible.builtin.debug:
        msg: "MultiClusterHub in namespace '{{ mce_namespace }}' is Running."
      when: mch_info is succeeded

    - name: Create ConfigMap for mirror registry
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'templates/mirrorRegistryConfigMap.j2') }}"

    - name: Find RHCOS ISO files in cache directory
      ansible.builtin.find:
        paths: "{{ rhcos_cache_dir }}"
        patterns: "rhcos-*.iso"
      register: rhcos_iso_files

    - name: Fail if no RHCOS ISO files found or more than one
      ansible.builtin.assert:
        that:
          - rhcos_iso_files.files | length > 0
          - rhcos_iso_files.files | length <= 1
        fail_msg: |
          No RHCOS ISO files found or more than one found in cache directory.
          Please check the cache directory: {{ rhcos_cache_dir }}
          and ensure only one RHCOS ISO file is present.

    - name: Set RHCOS version from ISO file name
      ansible.builtin.set_fact:
        rhcos_version: "{{ rhcos_iso_files.files 
        | map(attribute='path') 
        | first 
        | basename 
        | regex_replace('^rhcos-(.*?)-live-iso.*$', '\\1') }}"

    - name: Set RHCOS ISO URL
      ansible.builtin.set_fact:
        rhcos_iso_url: "http://{{ ansible_host }}:{{ share_http_iso_port }}/{{ rhcos_iso_files.files | map(attribute='path') | first | basename }}"

    - name: Copy RHCOS ISO to http_store data directory
      become: yes
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ http_store_data_dir }}/{{ item.path | basename }}"
        remote_src: yes
        mode: '0644'
      loop: "{{ rhcos_iso_files.files }}"
      when: rhcos_iso_files.files | length > 0

    - name: Create AgentServiceConfig
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'templates/agentServiceConfig.j2') }}"

    - name: Wait for assisted-service pod to be running
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ mce_namespace }}"
        label_selectors:
          - "app=assisted-service"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: "{{ timeout_assisted_service }}"
      register: assisted_service_wait

    - name: Report assisted-service pod status
      ansible.builtin.debug:
        msg: "assisted-service pod in namespace '{{ mce_namespace }}' is Ready."
      when: assisted_service_wait is succeeded

    - name: Apply Provisioning resource
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'templates/provisioning.j2') }}"

    - name: Wait for metal3 pods to be running (Checking for 3+ pods)
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: openshift-machine-api
        label_selectors:
          - "k8s-app in (metal3, cluster-baremetal-operator)"
      register: metal3_check
      until:
        - metal3_check.resources is defined
        - metal3_check.resources | length >= 3
        - metal3_check.resources | selectattr('status.phase', 'equalto', 'Running') | list | length >= 3
      retries: "{{ (timeout_metal3 | int / 10) | int }}"
      delay: 10
      ignore_errors: true

    - name: Report metal3 pods status
      ansible.builtin.debug:
        msg: |
          WARNING: Expected metal3 pods did not all reach Running status within {{ timeout_metal3 }} seconds.
          Current metal pods:
          {{ metal3_check.resources | selectattr('metadata.name', 'search', 'metal') | map(attribute='metadata.name') | list }}
      when: metal3_check is failed

    - name: Enable siteconfig component in MCH
      kubernetes.core.k8s_json_patch:
        api_version: operator.open-cluster-management.io/v1
        kind: MultiClusterHub
        name: "{{ mch_cr_name }}"
        namespace: "{{ mce_namespace }}"
        patch:
          - op: add
            path: /spec/overrides/components/-
            value:
              name: siteconfig
              enabled: true
      register: mch_siteconfig_patch
      failed_when: false

    - name: Wait for siteconfig-controller-manager deployment to exist
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: siteconfig-controller-manager
        namespace: "{{ mce_namespace }}"
      register: siteconfig_deployment_exists
      until: siteconfig_deployment_exists.resources | length > 0
      retries: 30
      delay: 10

    - name: Wait for siteconfig-controller-manager deployment to become available
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: siteconfig-controller-manager
        namespace: "{{ mce_namespace }}"
      register: siteconfig_deployment_status
      until:
        - siteconfig_deployment_status.resources | length > 0
        - siteconfig_deployment_status.resources[0].status.availableReplicas is defined
        - siteconfig_deployment_status.resources[0].status.availableReplicas >= 1
      retries: 20
      delay: 15

    - name: Report siteconfig-controller-manager status
      ansible.builtin.debug:
        msg: "siteconfig-controller-manager deployment in namespace '{{ mce_namespace }}' is Available."
      when: siteconfig_deployment_status is succeeded
