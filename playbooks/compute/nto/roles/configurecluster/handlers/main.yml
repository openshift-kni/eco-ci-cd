---
- name: Wait for machine config pool to be degraded
  kubernetes.core.k8s_info:
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfigPool
  register: machine_config_pool
  retries: 60
  delay: 5
  until: |
    machine_config_pool.resources | length > 0
    and
    (machine_config_pool.resources
      | community.general.json_query('[*].status.readyMachineCount') !=
      (machine_config_pool.resources | community.general.json_query('[*].status.machineCount')))
  listen: wait for mcp update

- name: Wait for machine config pool to be updated
  kubernetes.core.k8s_info:
    api_version: machineconfiguration.openshift.io/v1
    kind: MachineConfigPool
  register: machine_config_pool_post
  retries: 120
  delay: 10
  until: |
    not machine_config_pool_post.failed
    and
    machine_config_pool_post.resources | length > 0
    and
    (machine_config_pool_post.resources
      | community.general.json_query('[*].status.readyMachineCount') ==
      (machine_config_pool.resources | community.general.json_query('[*].status.machineCount')))
  listen: wait for mcp update

- name: Notify that Master MCP update is complete
  ansible.builtin.debug:
    msg: "âœ… All MachineConfigPool rollout is complete. All master nodes have rebooted."
  listen: wait for mcp update
