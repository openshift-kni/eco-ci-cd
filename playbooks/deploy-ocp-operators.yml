# This playbook is not officially supported and comes with no guarantees.
# Use it at your own risk. Ensure you test thoroughly in your environment
# before deploying to production.

## Overview:
# This Ansible playbook deploys multiple OpenShift operators using Operator Lifecycle Manager (OLM).
# It supports both connected and disconnected flows. In disconnected mode, it mirrors operator
# content to an internal registry and applies the generated CatalogSources/IDMS.

## Prerequisites:
# - Ansible 2.9+ installed on the control node.
# - Ansible control node configured with necessary permissions.
# - SSH Access to bastion hosts.
# - ocp version of link to operator release version
# - pre-configured hosts_vars and grup_vars directories
# - installed openshift cluster
# - KUBECONFIG file
# - Internal registry URL/credentials for disconnected mode (if disconnected=true)

## Roles Used
# - ocp_operator_mirror (disconnected mirroring)
# - ocp_operator_deployment (installs operators)

## Roles Requirements
# The playbook uses the following roles:
# - redhatci.ocp.olm_operator
# - redhatci.ocp.catalog_source

## Variables
# - disconnected (bool): set true to mirror & use internal registry, default is false
# - mirror_only (bool): set true to only mirror operators without installing them, default is false
# - kubeconfig (str): path to kubeconfig, exported to K8S_AUTH_KUBECONFIG
# - version (str): OCP major.minor used to pick catalog index images (e.g., 4.19)
# - ocp_operator_mirror_skip_internal_registry_cleanup (bool): set true to preserve existing mirrored
#     images in the internal registry (skips registry storage reset before mirroring), default is false
# - operators (list or JSON string): operator specs with fields such as:
#     name, catalog, nsname, channel, og_name, deploy_default_config

## Usage:
# - Ensure all required variables are defined in the inventory or host_vars/group_vars.
# - Execute the playbook using Ansible's command-line tool:

# Example 1: Mirror AND install operators (disconnected environment)
# ansible-playbook ./playbooks/deploy-ocp-operators.yaml -i ./inventories/ocp-deployment/deploy-ocp-hybrid-multinode.yml \
# --extra-vars 'kubeconfig="/path/to/kubeconfig" \
# disconnected=true \
# version="4.16" operators=[
# {"name":"sriov-network-operator","catalog":"redhat-operators","nsname":"openshift-sriov-network-operator","deploy_default_config":"true"},\
# {"name":"metallb-operator","catalog":"redhat-operators","nsname":"metallb-system","channel":"stable","og_spec":{},deploy_default_config: "true"}]

# Example 2: ONLY mirror operators (do not install)
# ansible-playbook ./playbooks/deploy-ocp-operators.yaml -i ./inventories/ocp-deployment/deploy-ocp-hybrid-multinode.yml \
# --extra-vars 'kubeconfig="/path/to/kubeconfig" \
# disconnected=true \
# mirror_only=true \
# version="4.16" operators=[
# {"name":"sriov-network-operator","catalog":"redhat-operators","nsname":"openshift-sriov-network-operator"},\
# {"name":"metallb-operator","catalog":"redhat-operators","nsname":"metallb-system","channel":"stable"}]

# Notes:
# - This playbook assumes the OCP cluster and bastion hosts are pre-installed and ready.
# - Test in a non-production environment before deploying.
# - operators can be a native YAML list or a JSON string; the play normalizes it.
# - when disconnected=true, the play mirrors operators first, then installs from mirrored catalogs.
# - when mirror_only=true, only mirroring is performed (useful for populating registries without installing).
# - mirror_only requires disconnected=true to have any effect.
---
- name: Deploy operator
  hosts: bastion
  gather_facts: true
  # Refer to the variables below as an example.
  vars:
    disconnected: false
    mirror_only: false  # Set to true to only mirror operators without installing
      # version: "4.17"
      # operators: # Refer as example
      #   - name: sriov-network-operator
      #     catalog: redhat-operators-stage
      #     nsname: openshift-sriov-network-operator
      #     deploy_default_config: true
      #   - name: ptp-operator
      #     catalog: redhat-operators-stage
      #     nsname: openshift-ptp
      #     ns_labels:
      #       workload.openshift.io/allowed: management
      #       name: openshift-ptp
      #   - name: kubernetes-nmstate-operator
      #     catalog: redhat-operators
      #     nsname: openshift-nmstate
      #   - name: sriov-fec
      #     catalog: certified-operators
      #     nsname: vran-acceleration-operators
      #     channel: stable
      #   - name: metallb-operator
      #     catalog: redhat-operators-stage
      #     nsname: metallb-system
      #     channel: stable
      #     deploy_default_config: true
      #     og_spec: {}

  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig }}"
  tasks:
    - name: Install requirements
      ansible.builtin.pip:
        name:
          - kubernetes==33.1.0
          - openshift
        state: present

    - name: Mirror Operators to internal registry for disconnected installation
      when: disconnected | bool
      ansible.builtin.include_role:
        name: ocp_operator_mirror
      vars:
        ocp_operator_mirror_registry_url: disconnected.registry.local:5000
        ocp_operator_mirror_registry_user: "{{ ansible_user }}"
        ocp_operator_mirror_registry_password: "{{ ansible_password }}"
        ocp_operator_mirror_pull_secret: "{{ pull_secret_string | b64decode }}"
        ocp_operator_mirror_version: "{{ version }}"
        ocp_operator_mirror_operators: "{{ operators }}"
        ocp_operator_mirror_kubeconfig: "{{ kubeconfig }}"
        ocp_operator_mirror_fbc_image_base: "{{ art_fbc_image_base }}"
        ocp_operator_mirror_art_images_share: "{{ art_share_image }}"

    # Workaround for missing ose-kube-rbac-proxy in the OCP 4.14 gitops operator
    # bundle relatedImages. The image is used in the CSV deployment but not declared
    # in the bundle metadata, so oc-mirror does not mirror it automatically.
    - name: Mirror missing ose-kube-rbac-proxy for OCP 4.14 gitops operator
      when:
        - disconnected | bool
        - version is defined
        - version.startswith('4.14')
        - (operators | from_json if operators is string else operators)
          | selectattr('name', 'search', 'gitops') | list | length > 0
      block:
        - name: Extract catalog for gitops operator from index image
          ansible.builtin.command:
            cmd: >-
              oc image extract
              registry.redhat.io/redhat/redhat-operator-index:v{{ version.split('.')[0:2] | join('.') }}
              --path /configs/openshift-gitops-operator/:/tmp/gitops-catalog
              --confirm --filter-by-os linux/amd64
          changed_when: true

        - name: Read gitops operator catalog content
          ansible.builtin.slurp:
            src: /tmp/gitops-catalog/catalog.json
          register: _catalog_content

        - name: Extract ose-kube-rbac-proxy digest from latest bundle
          ansible.builtin.set_fact:
            _rbac_proxy_digest: >-
              {{
                (_catalog_content.content | b64decode
                  | regex_findall('ose-kube-rbac-proxy@sha256:[a-f0-9]+'))
                | last | default('')
              }}

        - name: Mirror ose-kube-rbac-proxy image to disconnected registry
          when: _rbac_proxy_digest | length > 0
          vars:
            _rbac_proxy_image: "registry.redhat.io/openshift4/{{ _rbac_proxy_digest }}"
          ansible.builtin.command:
            cmd: >-
              skopeo copy --all
              --authfile {{ ocp_operator_mirror_pull_secret_path | default('/tmp/auth.json') }}
              --dest-tls-verify=false
              docker://{{ _rbac_proxy_image }}
              docker://disconnected.registry.local:5000/openshift4/{{ _rbac_proxy_digest }}
          changed_when: true

        - name: Clean up extracted catalog
          ansible.builtin.file:
            path: /tmp/gitops-catalog
            state: absent

    - name: Select operators source
      ansible.builtin.set_fact:
        operator_input: >-
          {{
            ocp_operators_mirror_disconnected_config
            if (((ocp_operators_mirror_disconnected_config | default([])) | length) > 0)
            else (operators | from_json if (operators is string) else operators)
          }}

    - name: Display mirror-only mode message
      ansible.builtin.debug:
        msg: "Mirror-only mode enabled. Skipping operator installation."
      when: mirror_only | bool

    - name: Install Operators
      when: not (mirror_only | bool)
      ansible.builtin.include_role:
        name: ocp_operator_deployment
      vars:
        ocp_operator_deployment_version: "{{ version }}"
        ocp_operator_deployment_operators: "{{ operator_input }}"
        ocp_operator_deployment_stage_repo_image: "{{ stage_catalog_index_image | default(omit) }}"
        ocp_operator_deployment_stage_cs_secret: "{{ registry_credentials | default(omit) }}"
