---
# This playbook configures LVM storage on OpenShift master nodes and creates
# LocalVolume resources for local storage operator.
#
# Prerequisites:
#   - SSH access to master nodes
#   - Valid kubeconfig for cluster authentication
#   - Local Storage Operator must be installed
#
# Usage:
#   ansible-playbook -i inventories/ocp-deployment/build-inventory.py \
#     playbooks/configure-lvm-storage.yml \
#     --extra-vars "kubeconfig=/path/to/kubeconfig"
#
# What it does:
#   1. Creates LVM volume group and logical volumes on master nodes
#   2. Creates OpenShift LocalVolume CRs to expose the volumes to the cluster
#   3. Sets local-sc as the default storage class

- name: Pre-flight validation
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Validate kubeconfig variable is defined
      ansible.builtin.assert:
        that:
          - kubeconfig is defined
          - kubeconfig | length > 0
        fail_msg: |
          Variable 'kubeconfig' must be defined.
          Pass it with --extra-vars 'kubeconfig=/path/to/kubeconfig'

- name: Configure LVM storage on master nodes
  hosts: masters
  become: true
  remote_user: core
  gather_facts: true
  gather_subset:
    - hardware
  tasks:
    - name: Set volume group name
      ansible.builtin.set_fact:
        vol_group_name: "new_vol_group"

    - name: Set local volume name
      ansible.builtin.set_fact:
        local_volume_name:
          - "vol1"
          - "vol2"

    - name: Find empty block devices from facts
      ansible.builtin.set_fact:
        empty_block_devices: >-
          {{ (ansible_devices | default({}))
             | dict2items
             | selectattr('key','match','^((sd|hd|vd|xvd)[a-z]+|nvme\\d+n\\d+)$')
             | rejectattr('value.removable','equalto','1')
             | selectattr('value.partitions','equalto',{})
             | selectattr('value.holders','equalto',[])
             | map(attribute='key')
             | list
             | first }}

    - name: Show empty block devices
      ansible.builtin.debug:
        var: empty_block_devices

    - name: Fail if no empty block devices
      ansible.builtin.assert:
        that:
          - empty_block_devices is defined
          - (empty_block_devices | length) > 0
        fail_msg: "No empty block devices found on {{ inventory_hostname }}"

    - name: Remove any existing volume group on {{ empty_block_devices }}
      community.general.lvg:
        vg: "{{ vol_group_name }}"
        pvs: "/dev/{{ empty_block_devices }}"
        state: absent
        force: true

    - name: Create volume group new_vol_group on {{ empty_block_devices }}
      community.general.lvg:
        vg: "{{ vol_group_name }}"
        pvs: "/dev/{{ empty_block_devices }}"
        state: present

    - name: Create logical volume (20GB) {{ item }}
      community.general.lvol:
        vg: "{{ vol_group_name }}"
        lv: "{{ item }}"
        size: 20G
        state: present
      loop: "{{ local_volume_name }}"

- name: Create LocalVolume resources on bastion
  hosts: bastion
  gather_facts: false
  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig }}"

  tasks:
    - name: Get Kubernetes node name for master
      kubernetes.core.k8s_info:
        kind: Node
      register: k8s_nodes

    - name: Set kubernetes node name
      ansible.builtin.set_fact:
        k8s_node_name: "{{ k8s_nodes.resources[0].metadata.name }}"

    - name: Display Kubernetes node name being used
      ansible.builtin.debug:
        msg: "Using Kubernetes node name: {{ k8s_node_name }}"

    - name: Apply localVolume configuration for {{ item }}
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'templates/localVolume.j2') }}"
      vars:
        local_volume_name: "{{ item }}"
        local_volume_namespace: openshift-local-storage
        vol_group_name: "{{ hostvars['master0'].vol_group_name }}"
      loop: "{{ hostvars['master0'].local_volume_name }}"

    - name: Make local-sc the default storage class
      kubernetes.core.k8s:
        state: patched
        definition:
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: local-sc
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"

    - name: Wait for LocalVolume resources to be created and ready
      kubernetes.core.k8s_info:
        kind: LocalVolume
        namespace: openshift-local-storage
        name: "{{ item }}"
      register: lv_resources
      until:
        - lv_resources.resources | length > 0
        - lv_resources.resources[0].status is defined
      retries: 30
      delay: 10
      loop: "{{ hostvars['master0'].local_volume_name }}"
