# This playbook is not officially supported and comes with no guarantees.
# Use it at your own risk. Ensure you test thoroughly in your environment
# before deploying to production.

## Overview:
# This Ansible playbook deploys multiple OpenShift operators using Operator Lifecycle Manager (OLM).
# It supports both connected and disconnected flows. In disconnected mode, it mirrors operator
# content to an internal registry and applies the generated CatalogSources/IDMS.

## Prerequisites:
# - Ansible 2.9+ installed on the control node.
# - Ansible control node configured with necessary permissions.
# - SSH Access to bastion hosts.
# - ocp version of link to operator release version
# - pre-configured hosts_vars and grup_vars directories
# - installed openshift cluster
# - KUBECONFIG file
# - Internal registry URL/credentials for disconnected mode (if disconnected=true)

## Roles Used
# - ocp_operator_mirror (disconnected mirroring)
# - ocp_operator_deployment (installs operators)

## Roles Requirements
# The playbook uses the following roles:
# - redhatci.ocp.olm_operator
# - redhatci.ocp.catalog_source

## Variables
# - disconnected (bool): set true to mirror & use internal registry, default is false
# - mirror_only (bool): set true to only mirror operators without installing them, default is false
# - kubeconfig (str): path to kubeconfig, exported to K8S_AUTH_KUBECONFIG
# - version (str): OCP major.minor used to pick catalog index images (e.g., 4.19)
# - operators (list or JSON string): operator specs with fields such as:
#     name, catalog, nsname, channel, og_name, deploy_default_config

## Usage:
# - Ensure all required variables are defined in the inventory or host_vars/group_vars.
# - Execute the playbook using Ansible's command-line tool:

# Example 1: Mirror AND install operators (disconnected environment)
# ansible-playbook ./playbooks/deploy-ocp-operators.yaml -i ./inventories/ocp-deployment/deploy-ocp-hybrid-multinode.yml \
# --extra-vars 'kubeconfig="/path/to/kubeconfig" \
# disconnected=true \
# version="4.16" operators=[
# {"name":"sriov-network-operator","catalog":"redhat-operators","nsname":"openshift-sriov-network-operator","deploy_default_config":"true"},\
# {"name":"metallb-operator","catalog":"redhat-operators","nsname":"metallb-system","channel":"stable","og_spec":{},deploy_default_config: "true"}]

# Example 2: ONLY mirror operators (do not install)
# ansible-playbook ./playbooks/deploy-ocp-operators.yaml -i ./inventories/ocp-deployment/deploy-ocp-hybrid-multinode.yml \
# --extra-vars 'kubeconfig="/path/to/kubeconfig" \
# disconnected=true \
# mirror_only=true \
# version="4.16" operators=[
# {"name":"sriov-network-operator","catalog":"redhat-operators","nsname":"openshift-sriov-network-operator"},\
# {"name":"metallb-operator","catalog":"redhat-operators","nsname":"metallb-system","channel":"stable"}]

# Notes:
# - This playbook assumes the OCP cluster and bastion hosts are pre-installed and ready.
# - Test in a non-production environment before deploying.
# - operators can be a native YAML list or a JSON string; the play normalizes it.
# - when disconnected=true, the play mirrors operators first, then installs from mirrored catalogs.
# - when mirror_only=true, only mirroring is performed (useful for populating registries without installing).
# - mirror_only requires disconnected=true to have any effect.
---
- name: Deploy operator
  hosts: bastion
  gather_facts: true
  # Refer to the variables below as an example.
  vars:
    disconnected: false
    mirror_only: false  # Set to true to only mirror operators without installing
      # version: "4.17"
    operators:
      # - name: local-storage-operator
      #   catalog: redhat-operators
      #   nsname: openshift-local-storage
      #   channel: stable
      #   og_name: local-operator-group
      #   subscription_name: local-storage-operator
      #   deploy_default_config: false
      #   ns_labels: 
      #     workload.openshift.io/allowed: management

      # - name: openshift-gitops-operator
      #   catalog: redhat-operators
      #   nsname: openshift-gitops-operator
      #   channel: latest
      #   og_name: openshift-gitops-operator
      #   subscription_name: openshift-gitops-operator
      #   deploy_default_config: false
      #   og_spec: 
      #     targetNamespaces: []

      # - name: advanced-cluster-management
      #   catalog: redhat-operators
      #   nsname: open-cluster-management
      #   channel: release-2.15
      #   og_name: open-cluster-management
      #   subscription_name: acm-operator-subscription
      #   deploy_default_config: false
      #   og_spec:
      #     targetNamespaces: ["open-cluster-management"]

      # - name: multicluster-engine
      #   catalog: redhat-operators
      #   nsname: multicluster-engine
      #   channel: stable-2.10
      #   og_name: multicluster-engine
      #   subscription_name: multicluster-engine
      #   deploy_default_config: true
      #   og_spec: {}

      # - name: topology-aware-lifecycle-manager
      #   catalog: topology-aware-lifecycle-manager-fbc
      #   og_name: global-operators
      #   nsname: openshift-operators
      #   fbc_iib_repo: latest
      #   channel: stable
      #   deploy_default_config: false
      #   ocp_operator_mirror_fbc_image_base: quay.io/redhat-user-workloads/telco-5g-tenant/topology-aware-lifecycle-manager-fbc-4-20

      # - name: cluster-logging
      #   catalog: redhat-operators
      #   nsname: openshift-logging
      #   channel: stable-6.4
      #   og_name: cluster-logging
      #   subscription_name: cluster-logging
      #   og_spec:
      #     targetNamespaces: []
      # - name: sriov-fec
      #   catalog: certified-operators
      #   nsname: vran-acceleration-operators
      #   channel: stable
      # - name: ptp-operator
      #   catalog: redhat-operators-ptp-art
      #   fbc_iib_repo: ose-ptp-rhel9-operator
      #   nsname: openshift-ptp
      #   channel: stable
      #   ns_labels:
      #     workload.openshift.io/allowed: management
      #     name: openshift-ptp
      # - name: sriov-network-operator
      #   catalog: redhat-operators-sriov-art
      #   fbc_iib_repo: ose-sriov-network-rhel9-operator
      #   nsname: openshift-sriov-network-operator
      #   channel: stable
      #   og_name: sriov-network-operators
      #   subscription_name: sriov-network-operator-subscription
      - name: local-storage-operator
        catalog: redhat-operators-storage-art
        fbc_iib_repo: ose-local-storage-rhel9-operator
        nsname: openshift-local-storage
        channel: stable
        og_name: local-operator-group
        subscription_name: local-storage-operator
        deploy_default_config: false
        ns_labels: 
          workload.openshift.io/allowed: management

  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig }}"
  tasks:
    - name: Install requirements
      ansible.builtin.pip:
        name:
          - kubernetes==33.1.0
          - openshift
        state: present

    - name: Mirror Operators to internal registry for disconnected installation
      when: disconnected | bool
      ansible.builtin.include_role:
        name: ocp_operator_mirror
      vars:
        ocp_operator_mirror_registry_url: disconnected.registry.local:5000
        ocp_operator_mirror_registry_user: "{{ ansible_user }}"
        ocp_operator_mirror_registry_password: "{{ ansible_password }}"
        ocp_operator_mirror_pull_secret: "{{ pull_secret_string | b64decode }}"
        ocp_operator_mirror_version: "{{ version }}"
        ocp_operator_mirror_operators: "{{ operators }}"
        ocp_operator_mirror_kubeconfig: "{{ kubeconfig }}"
        ocp_operator_mirror_fbc_image_base: "{{ art_fbc_image_base }}"
        ocp_operator_mirror_art_images_share: "{{ art_share_image }}"

    - name: Select operators source
      ansible.builtin.set_fact:
        operator_input: >-
          {{
            ocp_operators_mirror_disconnected_config
            if (((ocp_operators_mirror_disconnected_config | default([])) | length) > 0)
            else (operators | from_json if (operators is string) else operators)
          }}

    - name: Display mirror-only mode message
      ansible.builtin.debug:
        msg: "Mirror-only mode enabled. Skipping operator installation."
      when: mirror_only | bool

    - name: Install Operators
      when: not (mirror_only | bool)
      ansible.builtin.include_role:
        name: ocp_operator_deployment
      vars:
        ocp_operator_deployment_version: "{{ version }}"
        ocp_operator_deployment_operators: "{{ operator_input }}"
        ocp_operator_deployment_stage_repo_image: "{{ stage_catalog_index_image | default(omit) }}"
        ocp_operator_deployment_stage_cs_secret: "{{ registry_credentials | default(omit) }}"
