---
- name: Retrieve the existing global pull secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "pull-secret"
    namespace: "openshift-config"
  register: global_secret_info

- name: Decode the .dockerconfigjson content
    # The data is base64-encoded, so we decode it and save it to a local temporary file
  ansible.builtin.set_fact:
    existing_pull_secret: "{{ global_secret_info.resources[0].data['.dockerconfigjson'] | b64decode | string }}"
  when: global_secret_info.resources | length > 0

- name: Set existing and new pull secret
  ansible.builtin.set_fact:
    existing_pull_secret: "{{ existing_pull_secret | from_json }}"
    new_pull_secret: "{{ stage_pull_secret | from_json }}"

- name: Merging pull secret
  vars:
    merged_auths: "{{ existing_pull_secret.auths | combine(new_pull_secret.auths, recursive=True) }}"
  ansible.builtin.set_fact:
    merged_pull_secret: "{{ {'auths': merged_auths} }}"

- name: Patch the cluster's global pull secret
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    name: "pull-secret"
    namespace: "openshift-config"
    state: present
    definition:
      data:
        .dockerconfigjson: "{{ merged_pull_secret | to_nice_json | b64encode }}"
  notify:
    - wait for mcp update
