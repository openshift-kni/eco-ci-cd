---
# This playbook configures OpenShift GitOps (ArgoCD) to connect to a GitLab repository
# and enables ClusterInstance resources in the default AppProject.
#
# Prerequisites:
#   - Valid kubeconfig for cluster authentication
#   - OpenShift GitOps operator must be installed
#   - GitLab repository must be accessible from the cluster
#   - GitLab CA certificate (for self-signed or internal GitLab instances)
#
# Usage:
#   ansible-playbook -i inventories/ocp-deployment/build-inventory.py \
#     playbooks/ran/hub-sno-configure-gitops.yml \
#     --extra-vars "kubeconfig=/path/to/kubeconfig gitlab_repo_url=https://gitlab.example.com/repo.git'"
#
# Required variables:
#   kubeconfig: Path to kubeconfig file for cluster authentication
#   gitlab_repo_url: URL of the GitLab repository (e.g., "https://gitlab.example.com/group/repo.git")
#   gitlab_ca_certificate: CA certificate for GitLab server (required for self-signed or internal GitLab)
#
# What it does:
#   1. Validates required variables are defined
#   2. Patches gitops repo server deployment to use IfNotPresent image pull policy
#   3. Creates ConfigMap with GitLab CA certificate for TLS verification
#   4. Restarts gitops repo server deployment to apply changes
#   5. Waits for gitops repo server deployment to be ready
#   6. Verifies GitLab connectivity from repo server pod using curl
#   7. Ensures ClusterInstance resource is whitelisted in default AppProject
#
# Important Notes:
#   - The playbook assumes OpenShift GitOps is installed in openshift-gitops namespace
#   - GitLab CA certificate is required for self-signed certificates or internal GitLab instances
#   - The connectivity test verifies that the repo server pod can reach the GitLab URL
#   - ClusterInstance whitelist is required for ZTP (Zero Touch Provisioning) workflows

- name: Configure hub cluster to reach gitlab repo
  hosts: bastion
  gather_facts: false
  become: no
  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig }}"
  vars:
    gitops_namespace: openshift-gitops
    repo_server_deployment: openshift-gitops-repo-server
  tasks:
    - name: Validate required variables are defined
      ansible.builtin.assert:
        that:
          - kubeconfig is defined
          - gitlab_repo_url is defined
        fail_msg: "Required variables 'kubeconfig', and 'gitlab_repo_url' must be defined"
        success_msg: "All required variables are defined"

    - name: Patch imagepullpolicy to IfNotPresent for gitops repo server
      kubernetes.core.k8s:
        state: patched
        api_version: apps/v1
        kind: Deployment
        name: "{{ repo_server_deployment }}"
        namespace: "{{ gitops_namespace }}"
        definition:
          spec:
            template:
              spec:
                containers:
                  - name: argocd-repo-server
                    imagePullPolicy: IfNotPresent
      changed_when: true

    - name: Create gitlab ca certificate ConfigMap
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'templates/configMapCa.j2') }}"
      changed_when: true

    - name: Rollout gitops repo server deployment
      ansible.builtin.command:
        cmd: oc rollout restart deployment/{{ repo_server_deployment }} -n {{ gitops_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      changed_when: true

    - name: Wait for gitops repo server deployment to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ repo_server_deployment }}"
        namespace: "{{ gitops_namespace }}"
      register: repo_server_deployment_ready
      retries: 40
      delay: 5
      until: "repo_server_deployment_ready.resources[0].status.readyReplicas | default(0) == 1"

    - name: Verify GitLab connectivity from repo server pod
      ansible.builtin.shell: |
        POD_NAME=$(oc get pod -n {{ gitops_namespace }} \
          -l app.kubernetes.io/name={{ repo_server_deployment }} \
          -o jsonpath='{.items[0].metadata.name}')
        oc exec -n {{ gitops_namespace }} ${POD_NAME} -- \
          curl -sI --max-time 10 \
            {{ gitlab_repo_url }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: gitlab_curl_check
      failed_when:
        - gitlab_curl_check.rc != 0
        - >
          'Connection timed out' in gitlab_curl_check.stderr or
          'Could not resolve host' in gitlab_curl_check.stderr
      changed_when: false
      
    - name: Display connectivity test results
      ansible.builtin.debug:
        msg: |
          gitops repo server pod can reach GitLab.

    - name: Ensure ClusterInstance is in default AppProject namespaceResourceWhitelist
      kubernetes.core.k8s:
        api_version: argoproj.io/v1alpha1
        kind: AppProject
        name: default
        namespace: "{{ gitops_namespace }}"
        state: present
        merge_type: merge
        definition:
          spec:
            namespaceResourceWhitelist:
              - group: siteconfig.open-cluster-management.io
                kind: ClusterInstance
