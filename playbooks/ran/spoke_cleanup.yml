---
- name: Cleanup spoke cluster site 
  hosts: bastion
  gather_facts: false
  vars:
    hub_kubeconfig: "{{ hub_kubeconfig }}"
    openshift_gitops_namespace: openshift-gitops

  tasks:

    - name: Get CGUs 
      kubernetes.core.k8s_info:
        api_version: ran.openshift.io/v1alpha1
        kind: ClusterGroupUpgrade
        namespace: "ztp-install"
        kubeconfig: "{{ hub_kubeconfig }}"
      register: cgu_info

    - name: Print CGUs names found
      ansible.builtin.debug:
        msg: "CGUs found: {{ cgu_info.resources | map(attribute='metadata.name') | list }}"

    - name: Delete CGUs
      kubernetes.core.k8s:
        state: absent
        api_version: ran.openshift.io/v1alpha1
        kind: ClusterGroupUpgrade
        name: "{{ item.metadata.name }}"
        namespace: "ztp-install"
        kubeconfig: "{{ hub_kubeconfig }}"
      loop: "{{ cgu_info.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"

    - name: Delete ArgoCD apps before cleanup
      kubernetes.core.k8s:
        state: absent
        api_version: argoproj.io/v1alpha1
        kind: Application
        name: "{{ item }}"
        namespace: "{{ openshift_gitops_namespace }}"
        kubeconfig: "{{ hub_kubeconfig }}"
      loop:
        - clusters
        - policies
      ignore_errors: true

    - name: Wait for ArgoCD apps to be deleted 
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1alpha1
        kind: Application
        name: "{{ item }}"
        namespace: "{{ openshift_gitops_namespace }}"
        kubeconfig: "{{ hub_kubeconfig }}"
      register: app_check
      until: app_check.resources | length == 0
      retries: 12
      delay: 10
      loop:
        - clusters
        - policies
      ignore_errors: true

    - name: Cleanup spoke cluster resources
      include_tasks: tasks/site_cleanup.yml
      vars:
        hub_kubeconfig: "{{ hub_kubeconfig }}"
        spoke_cluster: "{{ spoke_cluster }}"

- name: Delete old cluster VMs to free up space on hypervisor
  hosts: hypervisor
  gather_facts: false
  become: true
  vars:
    # spoke_cluster should be passed as extra-var (e.g., kni-qe-100)
    # Pattern converts kni-qe-100 to kni-qe-100_ to match VM names like kni-qe-100_master0
    vm_name_pattern: "{{ spoke_cluster }}_"
  tasks:
    - name: Get list of all VMs from virsh
      ansible.builtin.command:
        cmd: virsh list --all --name
      register: virsh_list
      changed_when: false

    - name: Filter VMs matching spoke cluster pattern
      ansible.builtin.set_fact:
        vms_to_delete: "{{ virsh_list.stdout_lines | select('search', vm_name_pattern) | list }}"

    - name: Display VMs to be deleted
      ansible.builtin.debug:
        msg: "VMs to delete for {{ spoke_cluster }}: {{ vms_to_delete }}"

    - name: Destroy old cluster VMs
      community.libvirt.virt:
        name: "{{ item }}"
        command: destroy
      loop: "{{ vms_to_delete }}"
      ignore_errors: true  # VM might already be stopped
      when: vms_to_delete | length > 0

    - name: Undefine old cluster VMs with storage and nvram cleanup
      ansible.builtin.command:
        cmd: virsh undefine {{ item }} --remove-all-storage --nvram
      loop: "{{ vms_to_delete }}"
      register: undefine_result
      failed_when: undefine_result.rc != 0 and 'domain not found' not in undefine_result.stderr
      changed_when: undefine_result.rc == 0
      when: vms_to_delete | length > 0

    - name: Report no VMs found
      ansible.builtin.debug:
        msg: "No VMs found matching pattern '{{ vm_name_pattern }}'"
      when: vms_to_delete | length == 0
