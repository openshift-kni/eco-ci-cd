- name: Setup NTO gotests
  hosts: bastion
  gather_facts: false
  environment:
    K8S_AUTH_KUBECONFIG: "{{ kubeconfig }}"
  vars:
    must_gather_dir: "/must-gather"
    artifacts_folder: "/artifacts"

  tasks:
    - name: Create must gather directory
      ansible.builtin.include_tasks: ./nto/roles/configurecluster/tasks/create_directory.yml
      vars:
        dir_path: "{{ must_gather_dir }}"

    - name: Collect Must Gather
      ansible.builtin.shell: |
        oc adm must-gather --dest-dir="{{ must_gather_dir }}" --kubeconfig="{{ kubeconfig }}"
      register: must_gather
      changed_when: must_gather.rc == 0

    - name: Archive Must Gather
      community.general.archive:
        path: "{{ must_gather_dir }}"
        dest: "{{ artifacts_folder }}/mustgather.tar.gz"
        mode: 775
        format: gz
      become: true
